SOAPI.Animator=SOAPI.Class.extension();SOAPI.Animator.extend({parentNode:null,id:null,animations:null,construct:function(sprite,id){if(isString(sprite))sprite=document.getElementById(sprite);this.parentNode=sprite;this.parentNode.animators[id]=this;this.id=id;this.animations=[];},addAnimation:function(aIndex,properties,settings,custom){var p={left:[],top:[],width:[],height:[],clipTop:[],clipRight:[],clipBottom:[],clipLeft:[],opacity:[]};var s={interval:[40],frameMin:null,frameMax:null,stepLimit:null,direction:1,repeat:true,relative:false,action:[]};var c={};for(var pName in properties)p[pName]=properties[pName];for(var pName in settings)s[pName]=settings[pName];if(isObject(custom))c=custom;for(var pName in p){if(!isObject(p[pName]))p[pName]=[p[pName]];}for(var pName in c){if(!isObject(c[pName]))c[pName]=[c[pName]];}if(!isObject(s.interval))s.interval=[s.interval];if(!isObject(s.action))s.action=[s.action];var animation={timer:null,frame:0,step:1,busy:false,updated:false,properties:p,settings:s,custom:c};this.animations[aIndex]=animation;},runAnimation:function(aIndex){var animation=this.animations[aIndex];var properties=animation.properties;var settings=animation.settings;var custom=animation.custom;animation.frame+=settings.direction;animation.step++;if((settings.frameMax!=null&&animation.frame>settings.frameMax)||(settings.frameMin!=null&&animation.frame<settings.frameMin)||(settings.stepLimit&&animation.step>settings.stepLimit)){return this.doActions(aIndex);}for(var pName in properties)properties[pName].jumpBy(settings.direction,settings.repeat);for(var pName in custom)custom[pName].jumpBy(settings.direction,settings.repeat);animation.updated=false;if(!this.Update(aIndex))return this.doActions(aIndex);function timer(animator,aIndex){return function(){animator.runAnimation(aIndex);};}animation.timer=setTimeout(timer(this,aIndex),settings.interval.jumpBy(settings.direction,settings.repeat));},doActions:function(aIndex){this.Pause(aIndex);for(var i=0,action;action=this.animations[aIndex].settings.action[i];i++){if(isFunction(action))action();if(isString(action))eval(action);if(isArray(action)){for(var key in action)eval(action[key]);}}},Play:function(aIndex){if(this.animations[aIndex].busy)return;this.animations[aIndex].busy=true;this.runAnimation(aIndex);},PlayAll:function(){var aIndex=this.animations.length;while(aIndex--)this.Play(aIndex);},Stop:function(aIndex){this.Pause(aIndex);this.Reset(aIndex);},StopAll:function(){this.PauseAll();this.ResetAll();},Pause:function(aIndex){this.animations[aIndex].busy=false;clearTimeout(this.animations[aIndex].timer);},PauseAll:function(){var aIndex=this.animations.length;while(aIndex--)this.Pause(aIndex);},Reset:function(aIndex){var animation=this.animations[aIndex];var properties=animation.properties;var settings=animation.settings;var custom=animation.custom;animation.frame=0;animation.step=1;for(var pName in properties)properties[pName].jumpTo(0);for(var pName in custom)custom[pName].jumpTo(0);settings.interval.jumpTo(0);},ResetAll:function(){var aIndex=this.animations.length;while(aIndex--)this.Reset(aIndex);},Reverse:function(aIndex){this.animations[aIndex].settings.direction*=-1;},ReverseAll:function(){var aIndex=this.animations.length;while(aIndex--)this.Reverse(aIndex);},JumpTo:function(aIndex,frame){var animation=this.animations[aIndex];var properties=animation.properties;var settings=animation.settings;var custom=animation.custom;animation.frame=frame;for(var pName in properties)properties[pName].jumpTo(frame,settings.repeat);for(var pName in custom)custom[pName].jumpTo(frame,settings.repeat);settings.interval.jumpTo(frame,settings.repeat);},JumpToAll:function(frame){var aIndex=this.animations.length;while(aIndex--)this.JumpTo(aIndex,frame);},JumpBy:function(aIndex,frames){var animation=this.animations[aIndex];var properties=animation.properties;var settings=animation.settings;var custom=animation.custom;animation.frame+=frames;for(var pName in properties)properties[pName].jumpBy(frames,settings.repeat);for(var pName in custom)custom[pName].jumpBy(frames,settings.repeat);settings.interval.jumpBy(frames,settings.repeat);},JumpByAll:function(frames){var aIndex=this.animations.length;while(aIndex--)this.JumpBy(aIndex,frames);},Update:function(aIndex){var animation=this.animations[aIndex];var properties=animation.properties;var settings=animation.settings;var custom=animation.custom;var p={};var values=0;var method=(settings.relative)?"By":"To";if(settings.relative&&animation.updated)return;for(var pName in properties){p[pName]=properties[pName].current();if(p[pName]!=null)values++;}if(p.clipTop!=null||p.clipRight!=null||p.clipBottom!=null||p.clipLeft!=null){this.parentNode["clip"+method](p.clipTop,p.clipRight,p.clipBottom,p.clipLeft);}if(p.width!=null||p.height!=null)this.parentNode["size"+method](p.width,p.height);if(p.left!=null||p.top!=null)this.parentNode["move"+method](p.left,p.top);if(p.opacity!=null)this.parentNode["blend"+method](p.opacity);for(var pName in custom){var value=custom[pName].current();if(value==null)continue;values++;this.parentNode["style"+method](pName,value);}animation.updated=true;return values;},UpdateAll:function(){var aIndex=this.animations.length;while(aIndex--)this.Update(aIndex);},Clear:function(aIndex){this.Stop(aIndex);this.animations[aIndex]=null;},ClearAll:function(){var aIndex=this.animations.length;while(aIndex--)this.Clear(aIndex);}});